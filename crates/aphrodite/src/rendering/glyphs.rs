#[cfg(feature = "tile-rendering")]
use nannou::prelude::*;
#[cfg(feature = "tile-rendering")]
#[cfg(feature = "tile-rendering")]
use nannou::lyon::math::{point as lpoint, Angle};
#[cfg(feature = "tile-rendering")]
use nannou::lyon::path::builder::*;
#[cfg(feature = "tile-rendering")]
use nannou::lyon::path::ArcFlags;
use std::str::FromStr;

#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
pub enum Glyph {
    Sun, Moon, Mercury, Venus, Mars, Jupiter, Saturn, Uranus, Neptune, Pluto,
    Chiron, Lilith, NNode, SNode, Fortune,
    Aries, Taurus, Gemini, Cancer, Leo, Virgo, Libra, Scorpio, Sagittarius, Capricorn, Aquarius, Pisces,
    Ascendant, Descendant, MC, IC,
    House(u8),
    Unknown,
}

impl FromStr for Glyph {
    type Err = ();
    fn from_str(s: &str) -> Result<Self, Self::Err> {
         match s {
            "Sun" => Ok(Glyph::Sun),
            "Moon" => Ok(Glyph::Moon),
            "Mercury" => Ok(Glyph::Mercury),
            "Venus" => Ok(Glyph::Venus),
            "Mars" => Ok(Glyph::Mars),
            "Jupiter" => Ok(Glyph::Jupiter),
            "Saturn" => Ok(Glyph::Saturn),
            "Uranus" => Ok(Glyph::Uranus),
            "Neptune" => Ok(Glyph::Neptune),
            "Pluto" => Ok(Glyph::Pluto),
            "Chiron" => Ok(Glyph::Chiron),
            "Lilith" => Ok(Glyph::Lilith),
            "NNode" => Ok(Glyph::NNode),
            "SNode" => Ok(Glyph::SNode),
            "Fortune" => Ok(Glyph::Fortune),
            "Aries" => Ok(Glyph::Aries),
            "Taurus" => Ok(Glyph::Taurus),
            "Gemini" => Ok(Glyph::Gemini),
            "Cancer" => Ok(Glyph::Cancer),
            "Leo" => Ok(Glyph::Leo),
            "Virgo" => Ok(Glyph::Virgo),
            "Libra" => Ok(Glyph::Libra),
            "Scorpio" => Ok(Glyph::Scorpio),
            "Sagittarius" => Ok(Glyph::Sagittarius),
            "Capricorn" => Ok(Glyph::Capricorn),
            "Aquarius" => Ok(Glyph::Aquarius),
            "Pisces" => Ok(Glyph::Pisces),
            "As" => Ok(Glyph::Ascendant),
            "Ds" => Ok(Glyph::Descendant),
            "Mc" => Ok(Glyph::MC),
            "Ic" => Ok(Glyph::IC),
            s if s.chars().all(|c| c.is_numeric()) => {
                let n = s.parse::<u8>().map_err(|_| ())?;
                if n >= 1 && n <= 12 { Ok(Glyph::House(n)) } else { Ok(Glyph::Unknown) }
            },
            _ => Ok(Glyph::Unknown),
        }
    }
}

#[cfg(feature = "tile-rendering")]
fn draw_svg_path(draw: &Draw, path_data: &str, start: Point2, scale: f32, color: Srgba, stroke_width: f32) {
    let mut builder = nannou::geom::path::Builder::new().with_svg();
    
    let transform_point = |px: f32, py: f32| -> nannou::lyon::math::Point {
        let tx = (px - start.x) * scale + start.x;
        let ty = (py - start.y) * scale + start.y;
        lpoint(tx, ty)
    };

    let tokens: Vec<&str> = path_data
        .split(|c: char| c == ',' || c.is_whitespace())
        .filter(|s| !s.is_empty())
        .collect();
    
    let mut cursor = vec2(0.0, 0.0);
    let mut i = 0;
    while i < tokens.len() {
        let token = tokens[i];
        let cmd = token.chars().next().unwrap();
        match cmd {
            'M' | 'm' => {
                let is_rel = cmd == 'm';
                i += 1;
                while i + 1 < tokens.len() && (tokens[i].chars().next().unwrap().is_numeric() || tokens[i].starts_with('-')) {
                    let rx = tokens[i].parse::<f32>().unwrap_or(0.0);
                    let ry = tokens[i+1].parse::<f32>().unwrap_or(0.0);
                    i += 2;
                    let pt = if is_rel { cursor + vec2(rx, ry) } else { vec2(rx, ry) };
                    builder.move_to(transform_point(pt.x, pt.y));
                    cursor = pt;
                    
                    while i + 1 < tokens.len() && (tokens[i].chars().next().unwrap().is_numeric() || tokens[i].starts_with('-')) {
                         let lx = tokens[i].parse::<f32>().unwrap_or(0.0);
                         let ly = tokens[i+1].parse::<f32>().unwrap_or(0.0);
                         i += 2;
                         let lpt = if is_rel { cursor + vec2(lx, ly) } else { vec2(lx, ly) };
                         builder.line_to(transform_point(lpt.x, lpt.y));
                         cursor = lpt;
                    }
                }
            },
            'L' | 'l' => {
                let is_rel = cmd == 'l';
                i += 1;
                while i + 1 < tokens.len() && (tokens[i].chars().next().unwrap().is_numeric() || tokens[i].starts_with('-')) {
                    let rx = tokens[i].parse::<f32>().unwrap_or(0.0);
                    let ry = tokens[i+1].parse::<f32>().unwrap_or(0.0);
                    i += 2;
                    let pt = if is_rel { cursor + vec2(rx, ry) } else { vec2(rx, ry) };
                    builder.line_to(transform_point(pt.x, pt.y));
                    cursor = pt;
                }
            },
            'A' | 'a' => {
                let is_rel = cmd == 'a';
                i += 1;
                while i + 6 < tokens.len() && (tokens[i].chars().next().unwrap().is_numeric() || tokens[i].starts_with('-')) {
                    let rx = tokens[i].parse::<f32>().unwrap_or(0.0) * scale;
                    let ry = tokens[i+1].parse::<f32>().unwrap_or(0.0) * scale;
                    let x_rot = tokens[i+2].parse::<f32>().unwrap_or(0.0);
                    let large_arc = tokens[i+3] == "1";
                    let sweep = tokens[i+4] == "1";
                    let x = tokens[i+5].parse::<f32>().unwrap_or(0.0);
                    let y = tokens[i+6].parse::<f32>().unwrap_or(0.0);
                    i += 7;
                    let pt = if is_rel { cursor + vec2(x, y) } else { vec2(x, y) };
                    builder.arc_to(
                        nannou::lyon::math::vector(rx, ry),
                        Angle::degrees(x_rot), 
                        ArcFlags { large_arc, sweep }, 
                        transform_point(pt.x, pt.y)
                    );
                    cursor = pt;
                }
            },
            'C' | 'c' => { 
                let is_rel = cmd == 'c';
                i += 1;
                while i + 5 < tokens.len() && (tokens[i].chars().next().unwrap().is_numeric() || tokens[i].starts_with('-')) {
                    let c1x = tokens[i].parse::<f32>().unwrap_or(0.0);
                    let c1y = tokens[i+1].parse::<f32>().unwrap_or(0.0);
                    let c2x = tokens[i+2].parse::<f32>().unwrap_or(0.0);
                    let c2y = tokens[i+3].parse::<f32>().unwrap_or(0.0);
                    let x = tokens[i+4].parse::<f32>().unwrap_or(0.0);
                    let y = tokens[i+5].parse::<f32>().unwrap_or(0.0);
                    i += 6;
                    
                    let c1 = if is_rel { cursor + vec2(c1x, c1y) } else { vec2(c1x, c1y) };
                    let c2 = if is_rel { cursor + vec2(c2x, c2y) } else { vec2(c2x, c2y) };
                    let to = if is_rel { cursor + vec2(x, y) } else { vec2(x, y) };
                    
                    builder.cubic_bezier_to(
                        transform_point(c1.x, c1.y),
                        transform_point(c2.x, c2.y),
                        transform_point(to.x, to.y)
                    );
                    cursor = to;
                }
            },
            'Z' | 'z' => {
                builder.close();
                i += 1;
            }
             _ => { i += 1; while i < tokens.len() && (tokens[i].chars().next().unwrap().is_numeric() || tokens[i].starts_with('-')) { i += 1; } }
        }
    }
    
    draw.path()
        .stroke()
        .weight(stroke_width)
        .color(color)
        .events(builder.build().iter());
}

#[cfg(feature = "tile-rendering")]
pub fn draw_glyph(draw: &Draw, glyph: Glyph, center: Point2, size: f32, color: Srgba, stroke_width: f32) {
    let scale = size / 14.0;
    let x = center.x;
    let y = center.y;
    
    let path_data = match glyph {
        Glyph::Sun => {
            let x_s = x - 1.0 * scale; let y_s = y - 8.0 * scale;
            format!("m {}, {} -2.18182,0.727268 -2.181819,1.454543 -1.454552,2.18182 -0.727268,2.181819 0,2.181819 0.727268,2.181819 1.454552,2.18182 2.181819,1.454544 2.18182,0.727276 2.18181,0 2.18182,-0.727276 2.181819,-1.454544 1.454552,-2.18182 0.727268,-2.181819 0,-2.181819 -0.727268,-2.181819 -1.454552,-2.18182 -2.181819,-1.454543 -2.18182,-0.727268 -2.18181,0 m 0.727267,6.54545 -0.727267,0.727276 0,0.727275 0.727267,0.727268 0.727276,0 0.727267,-0.727268 0,-0.727275 -0.727267,-0.727276 -0.727276,0 m 0,0.727276 0,0.727275 0.727276,0 0,-0.727275 -0.727276,0", x_s, y_s)
        },
        Glyph::Moon => {
             let x_s = x - 2.0 * scale; let y_s = y - 7.0 * scale;
             format!("m {}, {} a 7.4969283,7.4969283 0 0 1 0,14.327462 7.4969283,7.4969283 0 1 0 0,-14.327462 z", x_s, y_s)
        },
        Glyph::Mercury => {
             let x_s = x - 2.0 * scale; let y_s = y + 7.0 * scale;
             let cx = (x - 2.0 * scale) + 6.0; let cy = (y + 7.0 * scale) - 16.0;
             format!("m {}, {} 4.26011,0 m -2.13005,-2.98207 0,5.11213 m 4.70312,-9.7983 a 4.70315,4.70315 0 0 1 -4.70315,4.70314 4.70315,4.70315 0 0 1 -4.70314,-4.70314 4.70315,4.70315 0 0 1 4.70314,-4.70315 4.70315,4.70315 0 0 1 4.70315,4.70315 z M {}, {} a 3.9717855,3.9717855 0 0 1 -3.95541,3.59054 3.9717855,3.9717855 0 0 1 -3.95185,-3.59445", x_s, y_s, cx, cy)
        },
        Glyph::Venus => {
             let x_s = x + 2.0 * scale; let y_s = y + 7.0 * scale;
             format!("m {}, {} -4.937669,0.03973 m 2.448972,2.364607 0,-5.79014 c -3.109546,-0.0085 -5.624617,-2.534212 -5.620187,-5.64208 0.0044,-3.107706 2.526514,-5.621689 5.635582,-5.621689 3.109068,0 5.631152,2.513983 5.635582,5.621689 0.0044,3.107868 -2.510641,5.633586 -5.620187,5.64208", x_s, y_s)
        },
        Glyph::Mars => {
             let x_s = x + 2.0 * scale; let y_s = y - 2.0 * scale;
             format!("m {}, {} c -5.247438,-4.150623 -11.6993,3.205518 -7.018807,7.886007 4.680494,4.680488 12.036628,-1.771382 7.885999,-7.018816 z m 0,0 0.433597,0.433595 3.996566,-4.217419 m -3.239802,-0.05521 3.295015,0 0.110427,3.681507", x_s, y_s)
        },
        Glyph::Jupiter => {
             let x_s = x - 5.0 * scale; let y_s = y - 2.0 * scale;
             format!("m {}, {} c -0.43473,0 -1.30422,-0.40572 -1.30422,-2.02857 0,-1.62285 1.73897,-3.2457 3.47792,-3.2457 1.73897,0 3.47792,1.21715 3.47792,4.05713 0,2.83999 -2.1737,7.30283 -6.52108,7.30283 m 12.17269,0 -12.60745,0 m 9.99902,-11.76567 0,15.82279", x_s, y_s)
        },
        Glyph::Saturn => {
             let x_s = x + 5.0 * scale; let y_s = y + 10.0 * scale;
             format!("m {}, {} c -0.52222,0.52221 -1.04445,1.04444 -1.56666,1.04444 -0.52222,0 -1.56667,-0.52223 -1.56667,-1.56667 0,-1.04443 0.52223,-2.08887 1.56667,-3.13332 1.04444,-1.04443 2.08888,-3.13331 2.08888,-5.22219 0,-2.08888 -1.04444,-4.17776 -3.13332,-4.17776 -1.97566,0 -3.65555,1.04444 -4.69998,3.13333 m -2.55515,-5.87499 6.26664,0 m -3.71149,-2.48054 0,15.14438", x_s, y_s)
        },
        Glyph::Uranus => {
             let x_s = x - 5.0 * scale; let y_s = y - 7.0 * scale;
             let xb = (x - 5.0 * scale) + 7.0; let yb = (y - 7.0 * scale) + 14.5;
             format!("m {}, {}  0,10.23824 m 10.23633,-10.32764 0,10.23824 m -10.26606,-4.6394 10.23085,0 m -5.06415,-5.51532 0,11.94985 M {}, {} a 1.8384377,1.8384377 0 0 1 -1.83844,1.83843 1.8384377,1.8384377 0 0 1 -1.83842,-1.83843 1.8384377,1.8384377 0 0 1 1.83842,-1.83844 1.8384377,1.8384377 0 0 1 1.83844,1.83844 z", x_s, y_s, xb, yb)
        },
        Glyph::Neptune => {
             let x_s = x + 3.0 * scale; let y_s = y - 5.0 * scale;
             format!("m {}, {} 1.77059,-2.36312 2.31872,1.8045 m -14.44264,-0.20006 2.34113,-1.77418 1.74085,2.38595 m -1.80013,-1.77265 c -1.23776,8.40975 0.82518,9.67121 4.95106,9.67121 4.12589,0 6.18883,-1.26146 4.95107,-9.67121 m -7.05334,3.17005 2.03997,-2.12559 2.08565,2.07903 m -5.32406,9.91162 6.60142,0 m -3.30071,-12.19414 0,15.55803", x_s, y_s)
        },
        Glyph::Pluto => {
             let x_s = x + 5.0 * scale; let y_s = y - 5.0 * scale;
             let xh = (x + 5.0 * scale) - 2.3; let yh = y - 5.0 * scale;
             format!("m {}, {} a 5.7676856,5.7676856 0 0 1 -2.88385,4.99496 5.7676856,5.7676856 0 0 1 -5.76768,0 5.7676856,5.7676856 0 0 1 -2.88385,-4.99496 m 5.76771,13.93858 0,-8.17088 m -3.84512,4.32576 7.69024,0 M {}, {} a 3.3644834,3.3644834 0 0 1 -3.36448,3.36449 3.3644834,3.3644834 0 0 1 -3.36448,-3.36449 3.3644834,3.3644834 0 0 1 3.36448,3.36448 z", x_s, y_s, xh, yh)
        },
        Glyph::Chiron => {
            let x_s = x + 3.0 * scale; let y_s = y + 5.0 * scale;
            let xh = x + 3.0 * scale; let yh = (y + 5.0 * scale) - 13.0;
            format!("m {}, {} a 3.8764725,3.0675249 0 0 1 -3.876473,3.067525 3.8764725,3.0675249 0 0 1 -3.876472,-3.067525 3.8764725,3.0675249 0 0 1 3.876472,-3.067525 3.8764725,3.0675249 0 0 1 3.876473,3.067525 z M {}, {} -3.942997,4.243844 4.110849,3.656151 m -4.867569,-9.009468 0,11.727251", x_s, y_s, xh, yh)
        },
        Glyph::Lilith => {
            let x_s = x + 2.0 * scale; let y_s = y + 4.0 * scale;
            format!("m {}, {} -2.525435,-1.12853 -1.464752,-1.79539 -0.808138,-2.20576 0.151526,-2.05188 0.909156,-1.5389 1.010173,-1.02593 0.909157,-0.56427 1.363735,-0.61556 m 2.315327,-0.39055 -1.716301,0.54716 -1.7163,1.09431 -1.1442,1.64146 -0.572102,1.64146 0,1.64146 0.572102,1.64147 1.1442,1.64145 1.7163,1.09432 1.716301,0.54715 m 0,-11.49024 -2.2884,0 -2.288401,0.54716 -1.716302,1.09431 -1.144201,1.64146 -0.5721,1.64146 0,1.64146 0.5721,1.64147 1.144201,1.64145 1.716302,1.09432 2.288401,0.54715 2.2884,0 m -4.36712,-0.4752 0,6.44307 m -2.709107,-3.41101 5.616025,0", x_s, y_s)
        },
        Glyph::NNode => {
            let x_s = x - 2.0 * scale; let y_s = y + 3.0 * scale;
            format!("m {}, {} -1.3333334,-0.6666667 -0.6666666,0 -1.3333334,0.6666667 -0.6666667,1.3333333 0,0.6666667 0.6666667,1.3333333 1.3333334,0.6666667 0.6666666,0 1.3333334,-0.6666667 0.6666666,-1.3333333 0,-0.6666667 -0.6666666,-1.3333333 -2,-2.66666665 -0.6666667,-1.99999995 0,-1.3333334 0.6666667,-2 1.3333333,-1.3333333 2,-0.6666667 2.6666666,0 2,0.6666667 1.3333333,1.3333333 0.6666667,2 0,1.3333334 -0.6666667,1.99999995 -2,2.66666665 -0.6666666,1.3333333 0,0.6666667 0.6666666,1.3333333 1.3333334,0.6666667 0.6666666,0 1.3333334,-0.6666667 0.6666667,-1.3333333 0,-0.6666667 -0.6666667,-1.3333333 -1.3333334,-0.6666667 -0.6666666,0 -1.3333334,0.6666667 m -7.9999999,-6 0.6666667,-1.3333333 1.3333333,-1.3333333 2,-0.6666667 2.6666666,0 2,0.6666667 1.3333333,1.3333333 0.6666667,1.3333333", x_s, y_s)
        },
        Glyph::SNode => {
            let x_s = x - 0.0 * scale; let y_s = y - 5.0 * scale;
           format!("m {}, {} l1.3333282470703125,0.666656494140625l0.6666717529296875,0l1.3333282470703125,-0.666656494140625l0.6666717529296875,-1.333343505859375l0,-0.666656494140625l-0.6666717529296875,-1.333343505859375l-1.3333282470703125,-0.666656494140625l-0.6666717529296875,0l-1.3333282470703125,0.666656494140625l-0.6666717529296875,1.333343505859375l0,0.666656494140625l0.6666717529296875,1.333343505859375l2,2.666656494140625l0.6666717529296875,2l0,1.333343505859375l-0.6666717529296875,2l-1.3333282470703125,1.333343505859375l-2,0.666656494140625l-2.6666717529296875,0l-2,-0.666656494140625l-1.3333282470703125,-1.333343505859375l-0.6666717529296875,-2l0,-1.333343505859375l0.6666717529296875,-2l2,-2.666656494140625l0.666656494140625,-1.333343505859375l0,-0.666656494140625l-0.666656494140625,-1.333343505859375l-1.333343505859375,-0.666656494140625l-0.666656494140625,0l-1.333343505859375,0.666656494140625l-0.666656494140625,1.333343505859375l0,0.666656494140625l0.666656494140625,1.333343505859375l1.333343505859375,0.666656494140625l0.666656494140625,0l1.333343505859375,-0.666656494140625m8,6l-0.6666717529296875,1.333343505859375l-1.3333282470703125,1.33331298828125l-2,0.66668701171875l-2.6666717529296875,0l-2,-0.66668701171875l-1.3333282470703125,-1.33331298828125l-0.6666717529296875,-1.333343505859375", x_s, y_s)
        },
        Glyph::Fortune => {
             String::new() // Defer
        },
        Glyph::Aries => {
            let x_s = x - 9.0 * scale; let y_s = y - 2.0 * scale;
            format!("m {}, {} -0.9,-0.9 0,-1.8 0.9,-1.8 1.8,-0.8999998 1.8,0 1.8,0.8999998 0.9,0.9 0.9,1.8 0.9,4.5 m -9,-5.4 1.8,-1.8 1.8,0 1.8,0.9 0.9,0.9 0.9,1.8 0.9,3.6 0,9.9 m 8.1,-12.6 0.9,-0.9 0,-1.8 -0.9,-1.8 -1.8,-0.8999998 -1.8,0 -1.8,0.8999998 -0.9,0.9 -0.9,1.8 -0.9,4.5 m 9,-5.4 -1.8,-1.8 -1.8,0 -1.8,0.9 -0.9,0.9 -0.9,1.8 -0.9,3.6 0,9.9", x_s, y_s)
        },
        Glyph::Taurus => {
            let x_s = x - 9.0 * scale; let y_s = y - 11.0 * scale;
            format!("m {}, {} 1,4 1,2 2,2 3,1 4,0 3,-1 2,-2 1,-2 1,-4 m -18,0 1,3 1,2 2,2 3,1 4,0 3,-1 2,-2 1,-2 1,-3 m -11,8 -2,1 -1,1 -1,2 0,3 1,2 2,2 2,1 2,0 2,-1 2,-2 1,-2 0,-3 -1,-2 -1,-1 -2,-1 m -4,1 -2,1 -1,2 0,3 1,3 m 8,0 1,-3 0,-3 -1,-2 -2,-1", x_s, y_s)
        },
        Glyph::Gemini => {
            let x_s = x - 6.0 * scale; let y_s = y - 6.0 * scale;
            format!("m {}, {} 0,11.546414 m 0.9622011,-10.5842129 0,9.6220117 m 7.6976097,-9.6220117 0,9.6220117 m 0.962201,-10.5842128 0,11.546414 m -13.4708165,-14.4330172 1.9244023,1.924402 1.9244024,0.9622012 2.8866038,0.9622011 3.848804,0 2.886604,-0.9622011 1.924402,-0.9622012 1.924403,-1.924402 m -17.3196215,17.3196207 1.9244023,-1.9244024 1.9244024,-0.9622011 2.8866038,-0.9622012 3.848804,0 2.886604,0.9622012 1.924402,0.9622011 1.924403,1.9244024", x_s, y_s)
        },
        Glyph::Cancer => {
            let x_s = x + 9.0 * scale; let y_s = y - 9.0 * scale;
            format!("m {}, {} -15,0 -2,1 -1,2 0,2 1,2 2,1 2,0 2,-1 1,-2 0,-2 -1,-2 11,0 m -18,3 1,2 1,1 2,1 m 4,-4 -1,-2 -1,-1 -2,-1 m -4,15 15,0 2,-1 1,-2 0,-2 -1,-2 -2,-1 -2,0 -2,1 -1,2 0,2 1,2 -11,0 m 18,-3 -1,-2 -1,-1 -2,-1 m -4,4 1,2 1,1 2,1", x_s, y_s)
        },
        Glyph::Leo => {
            let x_s = x - 3.0 * scale; let y_s = y + 4.0 * scale;
            format!("m {}, {} -2,-1 -1,0 -2,1 -1,2 0,1 1,2 2,1 1,0 2,-1 1,-2 0,-1 -1,-2 -5,-5 -1,-2 0,-3 1,-2 2,-1 3,-1 4,0 4,1 2,2 1,2 0,3 -1,3 -3,3 -1,2 0,2 1,2 2,0 1,-1 1,-2 m -13,-5 -2,-3 -1,-2 0,-3 1,-2 1,-1 m 7,-1 3,1 2,2 1,2 0,3 -1,3 -2,3", x_s, y_s)
        },
        Glyph::Virgo => {
            let x_s = x - 9.0 * scale; let y_s = y - 5.0 * scale;
            format!("m {}, {} 2.5894868,-2.5894868 1.7263245,2.5894868 0,9.4947847 m -2.5894868,-11.2211092 1.7263245,2.5894867 0,8.6316225 m 0.8631623,-9.4947847 2.5894867,-2.5894868 1.72632451,2.5894868 0,8.6316224 m -2.58948671,-10.3579469 1.72632447,2.5894867 0,7.7684602 m 0.86316224,-8.6316224 2.58948679,-2.5894868 1.7263244,2.5894868 0,13.8105959 m -2.5894867,-15.5369204 1.7263245,2.5894867 0,12.9474337 m 0.8631622,-13.8105959 2.5894868,-2.5894868 0.8631622,1.7263245 0.8631623,2.5894868 0,2.5894867 -0.8631623,2.58948673 -0.8631622,1.72632447 -1.7263245,1.7263245 -2.5894867,1.7263245 -4.3158113,1.7263245 m 7.7684602,-15.5369204 0.8631623,0.8631622 0.8631622,2.5894868 0,2.5894867 -0.8631622,2.58948673 -0.8631623,1.72632447 -1.7263245,1.7263245 -2.5894867,1.7263245 -3.452649,1.7263245", x_s, y_s)
        },
        Glyph::Libra => {
            let x_s = x - 2.0 * scale; let y_s = y - 8.0 * scale;
            format!("m {}, {} c 0.7519,1e-5 1.3924,0.12227 1.9316,0.35156 0.6619,0.28495 1.2134,0.63854 1.666,1.0625 0.4838,0.45481 0.853,0.97255 1.1172,1.56641 0.2467,0.56612 0.3711,1.17397 0.3711,1.83789 0,0.64113 -0.1244,1.23948 -0.373,1.80859 -0.1624,0.36305 -0.3631,0.69725 -0.6055,1.00586 l -0.6367,0.8086 4.3789,0 0,0.67187 -5.4024,0 0,-0.91797 c 0.2173,-0.1385 0.4379,-0.27244 0.6367,-0.44726 0.4215,-0.36876 0.7529,-0.82784 0.9883,-1.35547 0.2215,-0.50074 0.334,-1.0358 0.334,-1.58594 0,-0.55653 -0.1122,-1.09434 -0.334,-1.5957 l -0,-0.002 0,-0.004 c -0.2292,-0.49901 -0.5581,-0.94778 -0.9746,-1.33789 l -0,-0.002 -0,-0.002 c -0.3967,-0.36155 -0.8679,-0.65723 -1.4062,-0.88476 l -0,0 c -0.4984,-0.20903 -1.0622,-0.30663 -1.6817,-0.30664 -0.5926,1e-5 -1.1526,0.10008 -1.6699,0.30273 l -0,0 c -0.5261,0.20799 -1.0032,0.5067 -1.4199,0.88867 l -0,0.002 -0,0.002 c -0.4166,0.39011 -0.7454,0.83887 -0.9746,1.33789 l 0,0.004 -0,0.002 c -0.2218,0.50136 -0.334,1.03915 -0.334,1.5957 0,0.55015 0.1125,1.08519 0.334,1.58594 l 0,0.002 0,0.004 c 0.229,0.49855 0.5574,0.94911 0.9746,1.33984 0.1876,0.17482 0.4143,0.31484 0.6367,0.45703 l 0,0.91797 -5.3906,0 0,-0.67187 4.3789,0 -0.6367,-0.8086 c -0.2428,-0.30904 -0.443,-0.64418 -0.6055,-1.00781 -0.2487,-0.56911 -0.3731,-1.16552 -0.3731,-1.80664 0,-0.66391 0.1244,-1.27178 0.3711,-1.83789 l 0,-0.002 c 3e-4,-5.8e-4 -2e-4,-10e-4 0,-0.002 0.2641,-0.59218 0.6326,-1.10871 1.1153,-1.5625 0.4847,-0.45571 1.0332,-0.80585 1.6562,-1.05859 0.5861,-0.23488 1.2294,-0.35546 1.9414,-0.35547 z m -7.8496,13.45899 15.6992,0 0,0.67187 -15.6992,0 z", x_s, y_s)
        },
        Glyph::Scorpio => {
            let x_s = x - 9.0 * scale; let y_s = y - 4.0 * scale;
            format!("m {}, {} 2.3781101,-2.3781101 2.3781101,2.3781101 0,9.5124404 m -3.1708135,-11.0978471 2.3781101,2.3781101 0,8.719737 m 0.7927034,-9.5124404 2.3781101,-2.3781101 2.37811007,2.3781101 0,9.5124404 m -3.17081347,-11.0978471 2.3781101,2.3781101 0,8.719737 m 0.79270337,-9.5124404 2.37811013,-2.3781101 2.3781101,2.3781101 0,8.719737 1.5854067,1.5854068 m -4.7562202,-11.8905505 2.3781101,2.3781101 0,8.719737 1.5854067,1.5854067 2.3781101,-2.3781101", x_s, y_s)
        },
        Glyph::Sagittarius => {
            let x_s = x + 7.0 * scale; let y_s = y - 9.0 * scale;
            format!("m {}, {} -17.11444,17.11444 m 17.11444,-17.11444 -3.2089575,1.0696525 -6.417915,0 m 7.4875675,1.0696525 -3.2089575,0 -4.27861,-1.0696525 m 9.6268725,-1.0696525 -1.0696525,3.2089575 0,6.41791504 m -1.0696525,-7.48756754 0,3.2089575 1.0696525,4.27861004 m -8.55722,0 -7.4875675,0 m 6.417915,1.06965246 -3.2089575,0 -3.2089575,-1.06965246 m 7.4875675,0 0,7.48756746 m -1.0696525,-6.417915 0,3.2089575 1.0696525,3.2089575", x_s, y_s)
        },
        Glyph::Capricorn => {
            let x_s = x - 9.0 * scale; let y_s = y - 3.0 * scale;
            format!("m {}, {} 1.8047633,-3.6095267 4.5119084,9.0238168 m -4.5119084,-7.2190534 4.5119084,9.0238167 2.707145,-6.3166717 4.5119084,0 2.707145,-0.9023817 0.9023817,-1.8047633 0,-1.8047634 -0.9023817,-1.8047633 -1.8047634,-0.9023817 -0.9023816,0 -1.8047634,0.9023817 -0.9023817,1.8047633 0,1.8047634 0.9023817,2.707145 0.9023817,1.80476336 0.9023817,2.70714504 0,2.707145 -1.8047634,1.8047633 m 1.8047634,-16.2428701 -0.9023817,0.9023817 -0.9023817,1.8047633 0,1.8047634 1.8047634,3.6095267 0.9023816,2.707145 0,2.707145 -0.9023816,1.8047634 -1.8047634,0.9023816", x_s, y_s)
        },
        Glyph::Aquarius => {
            let x_s = x - 8.0 * scale; let y_s = y - 2.0 * scale;
            format!("m {}, {} 2.8866035,-2.8866035 3.8488047,1.9244023 m -4.8110059,-0.9622011 3.8488047,1.9244023 2.8866035,-2.8866035 2.8866035,1.9244023 m -3.84880467,-0.9622011 2.88660347,1.9244023 2.8866035,-2.8866035 1.9244024,1.9244023 m -2.8866035,-0.9622011 1.9244023,1.9244023 2.8866035,-2.8866035 m -17.319621,8.6598105 2.8866035,-2.88660348 3.8488047,1.92440238 m -4.8110059,-0.96220121 3.8488047,1.92440231 2.8866035,-2.88660348 2.8866035,1.92440238 m -3.84880467,-0.96220121 2.88660347,1.92440231 2.8866035,-2.88660348 1.9244024,1.92440238 m -2.8866035,-0.96220121 1.9244023,1.92440231 2.8866035,-2.88660348", x_s, y_s)
        },
        Glyph::Pisces => {
            let x_s = x - 8.0 * scale; let y_s = y - 8.0 * scale;
            format!("m {}, {} 4,2 2,2 1,3 0,3 -1,3 -2,2 -4,2 m 0,-17 3,1 2,1 2,2 1,3 m 0,3 -1,3 -2,2 -2,1 -3,1 m 16,-17 -3,1 -2,1 -2,2 -1,3 m 0,3 1,3 2,2 2,1 3,1 m 0,-17 -4,2 -2,2 -1,3 0,3 1,3 2,2 4,2 m -17,-9 18,0 m -18,1 18,0", x_s, y_s)
        }, 
        Glyph::Ascendant => {
            let x_s = x - 8.0 * scale; let y_s = y - 3.0 * scale;
            format!("m {}, {} 2.5,-3.5 6,12 m -6,-9.5 6,9.5 m -6.2,-4 6.2,0 m 2.5,-3.5 2.5,2.5 -1.2,1.2 a 1.25,2 0 0 0 -1.8,-1.2 1.25,2 0 0 0 0,3.5 1.25,2 0 0 0 1.8,-1.2", x_s, y_s)
        },
        Glyph::Descendant => {
            let x_s = x - 8.0 * scale; let y_s = y - 4.0 * scale;
            format!("m {}, {} 0,11 6,0 c 3,0 6,-2.5 6,-5.5 0,-3 -3,-5.5 -6,-5.5 z m 12.5,3.5 2.5,2.5 -1.2,1.2 a 1.25,2 0 0 0 -1.8,-1.2 1.25,2 0 0 0 0,3.5 1.25,2 0 0 0 1.8,-1.2", x_s, y_s)
        },
        Glyph::MC => {
            let x_s = x - 7.0 * scale; let y_s = y - 3.0 * scale;
            format!("m {}, {} 0,12 0,-10 6,10 6,-10 0,12 m 2,-12 -1.2,1.2 a 1.25,2 0 0 0 -1.8,-1.2 1.25,2 0 0 0 0,3.5 1.25,2 0 0 0 1.8,-1.2", x_s, y_s)
        },
        Glyph::IC => {
            let x_s = x - 4.0 * scale; let y_s = y - 3.0 * scale;
            format!("m {}, {} 0,12 0,-12 m 4,-2 -1.2,1.2 a 1.25,2 0 0 0 -1.8,-1.2 1.25,2 0 0 0 0,3.5 1.25,2 0 0 0 1.8,-1.2 m 2.2,2.2 2.5,-3.5 6,12 m -6,-9.5 6,9.5 m -6.2,-4 6.2,0", x_s, y_s)
        },
        Glyph::House(n) => {
            // Simplified house numbers using pre-defined paths for 1-12
            // Since this is dynamic (Glyph::House(n)), we can't easily match 'n' in a static match arm 
            // unless we list all 12.
            // But we can return the string dynamically if we had the map.
            // For now, I will add explicit matches for 1..12 below if time permits, 
            // or just use text fallthrough?
            // Actually, AstroChart uses SVG paths for numbers to style them.
            // I'll list them as House(1) => ..., House(2) => ...
            match n {
                1 => { let x_s=x-2.0*scale; let y_s=y-5.0*scale; format!("m {},{} 0,9 m -3,-7 3,-2", x_s, y_s) },
                2 => { let x_s=x-3.0*scale; let y_s=y-5.0*scale; format!("m {},{} c 1,-1 3,-2 5,0 1,2 -2,4 -5,9 l 6,0", x_s, y_s) },
                3 => { let x_s=x-3.0*scale; let y_s=y-5.0*scale; format!("m {},{} 1,0 c 3,0 5,1 4,4 -1,2 -3,2 -4,1 m 1,0 c 2,0 5,1 4,4 -1,2 -4,1 -5,0", x_s, y_s) },
                4 => { let x_s=x-3.0*scale; let y_s=y-5.0*scale; format!("m {},{} 0,6 6,0 m -2,3 0,-9", x_s, y_s) },
                5 => { let x_s=x-3.0*scale; let y_s=y-5.0*scale; format!("m {},{} 0,4 c 1,-3 5,-4 6,-1 1,3 -2,6 -6,6 -1,0 -1,0 -2,0 m -2,-9 6,0", x_s, y_s) },
                6 => { let x_s=x-3.0*scale; let y_s=y-5.0*scale; format!("m {},{} 1,-1 c -1,3 -1,6 1,8 2,2 5,2 6,-2 0,-2 -2,-4 -4,-4 -2,0 -4,2 -4,4", x_s, y_s) },
                7 => { let x_s=x-3.0*scale; let y_s=y-5.0*scale; format!("m {},{} 0,2 6,-2 -4,9", x_s, y_s) },
                8 => { let x_s=x-3.0*scale; let y_s=y-5.0*scale; format!("m {},{} c 1,-1 4,-1 5,1 1,2 -1,3 -2,3 -1,0 -2,-1 -2,-3 m 2,3 c -1,1 -4,1 -5,3 -1,2 1,4 4,4 3,0 5,-2 4,-4 -1,-2 -3,-2 -3,-3", x_s, y_s) },
                9 => { let x_s=x-3.0*scale; let y_s=y-5.0*scale; format!("m {},{} c -1,-3 -2,-4 1,-4 3,0 5,2 4,5 -1,2 -1,5 0,8 m 0,-8 c -3,0 -5,-2 -4,-5", x_s, y_s) },
                10 => { let x_s=x-7.0*scale; let y_s=y-5.0*scale; format!("m {},{} 0,9 m -3,-7 3,-2 m 6,0 c -1,2 -1,7 0,9 1,2 4,2 5,0 1,-2 1,-7 0,-9 -1,-2 -4,-2 -5,0", x_s, y_s) },
                11 => { let x_s=x-7.0*scale; let y_s=y-5.0*scale; format!("m {},{} 0,9 m -3,-7 3,-2 m 6,0 0,9 m -3,-7 3,-2", x_s, y_s) },
                12 => { let x_s=x-7.0*scale; let y_s=y-5.0*scale; format!("m {},{} 0,9 m -3,-7 3,-2 m 4,0 c 1,-1 3,-2 5,0 1,2 -2,4 -5,9 l 6,0", x_s, y_s) },
                _ => String::new(),
            }
        },
        _ => String::new(),
    };
    
    if !path_data.is_empty() {
        draw_svg_path(draw, &path_data, center, scale, color, stroke_width);
    } else {
        draw.ellipse().xy(center).radius(size/2.0).no_fill().stroke_color(color).stroke_weight(stroke_width);
    }
}
